name: éªŒè¯é…ç½®

on:
  push:
    branches: [ main, dev ]
    paths:
      - '.env.*'
      - 'scripts/config-manager.mjs'
      - 'scripts/validate-config.mjs'
      - 'core/src/types/config.ts'
      - 'core/src/config/**'
      - 'package.json'
      - '.github/workflows/validate-config.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '.env.*'
      - 'scripts/config-manager.mjs'
      - 'scripts/validate-config.mjs'
      - 'core/src/types/config.ts'
      - 'core/src/config/**'
      - 'package.json'

jobs:
  validate-config:
    name: é…ç½®éªŒè¯
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        environment: [development, test, production]
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: å®‰è£…ä¾èµ–
        run: yarn install --frozen-lockfile

      - name: éªŒè¯é…ç½®æ–‡ä»¶å­˜åœ¨æ€§
        run: yarn config:validate:files

      - name: éªŒè¯ ${{ matrix.environment }} ç¯å¢ƒé…ç½®
        run: node ./scripts/config-manager.mjs validate ${{ matrix.environment }}
        env:
          NODE_ENV: ${{ matrix.environment }}
          # ä¸ºç”Ÿäº§ç¯å¢ƒæä¾›æ¨¡æ‹Ÿçš„æ•æ„Ÿé…ç½®ï¼Œé¿å…éªŒè¯å¤±è´¥
          POSTHOG_KEY: ${{ matrix.environment == 'production' && 'mock-key' || '' }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ matrix.environment == 'production' && 'mock-key' || '' }}

      - name: å¯¼å‡ºé…ç½® (${{ matrix.environment }})
        run: node ./scripts/config-manager.mjs export ${{ matrix.environment }} config-${{ matrix.environment }}.json

      - name: ä¸Šä¼ é…ç½®æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: config-report-${{ matrix.environment }}
          path: config-${{ matrix.environment }}.json
          retention-days: 7

  validate-gitignore:
    name: éªŒè¯ Gitignore ä¿æŠ¤
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: å®‰è£…ä¾èµ–
        run: yarn install --frozen-lockfile

      - name: éªŒè¯ .gitignore ä¿æŠ¤
        run: node ./scripts/validate-config.mjs gitignore

      - name: æ£€æŸ¥æ•æ„Ÿæ–‡ä»¶æ˜¯å¦è¢«æ„å¤–æäº¤
        run: |
          if git ls-files | grep -E '\.(env\.local|env\..*\.local)$'; then
            echo "âŒ å‘ç°è¢«æ„å¤–æäº¤çš„æ•æ„Ÿé…ç½®æ–‡ä»¶!"
            exit 1
          fi
          echo "âœ… æ²¡æœ‰å‘ç°è¢«æ„å¤–æäº¤çš„æ•æ„Ÿé…ç½®æ–‡ä»¶"

  generate-report:
    name: ç”Ÿæˆé…ç½®æŠ¥å‘Š
    runs-on: ubuntu-latest
    needs: [validate-config, validate-gitignore]
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'

      - name: å®‰è£…ä¾èµ–
        run: yarn install --frozen-lockfile

      - name: ç”Ÿæˆå®Œæ•´é…ç½®æŠ¥å‘Š
        run: yarn config:report
        env:
          # ä¸ºæŠ¥å‘Šç”Ÿæˆæä¾›æ¨¡æ‹Ÿé…ç½®
          POSTHOG_KEY: mock-posthog-key
          OPENAI_API_KEY: mock-openai-key
          GROK_API_KEY: mock-grok-key
          TAURI_SIGNING_PRIVATE_KEY: mock-signing-key

      - name: ä¸Šä¼ å®Œæ•´é…ç½®æŠ¥å‘Š
        uses: actions/upload-artifact@v4
        with:
          name: complete-config-report
          path: config-report.json
          retention-days: 30

      - name: æ˜¾ç¤ºé…ç½®æŠ¥å‘Šæ‘˜è¦
        run: |
          if [ -f "config-report.json" ]; then
            echo "ğŸ“Š é…ç½®æŠ¥å‘Šæ‘˜è¦:"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            node -pe "
              const report = JSON.parse(require('fs').readFileSync('config-report.json', 'utf8'));
              console.log(\`âœ… æœ‰æ•ˆç¯å¢ƒ: \${report.summary.valid}/\${report.summary.total}\`);
              console.log(\`âš ï¸  è­¦å‘Šæ•°é‡: \${report.summary.warnings}\`);
              console.log(\`âŒ é”™è¯¯æ•°é‡: \${report.summary.errors}\`);
              console.log(\`ğŸ“… ç”Ÿæˆæ—¶é—´: \${new Date(report.timestamp).toLocaleString()}\`);
            "
          fi

  security-scan:
    name: å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æ‰«æç¡¬ç¼–ç å¯†é’¥
        run: |
          echo "ğŸ” æ‰«æç¡¬ç¼–ç å¯†é’¥..."
          
          # æ£€æŸ¥å¸¸è§çš„å¯†é’¥æ¨¡å¼
          patterns=(
            "api[_-]?key[s]?\s*[:=]\s*['\"][^'\"]{8,}"
            "secret[_-]?key[s]?\s*[:=]\s*['\"][^'\"]{8,}"
            "password[s]?\s*[:=]\s*['\"][^'\"]{8,}"
            "token[s]?\s*[:=]\s*['\"][^'\"]{8,}"
            "private[_-]?key\s*[:=]\s*['\"][^'\"]{8,}"
          )
          
          found_issues=false
          
          for pattern in "${patterns[@]}"; do
            if grep -r -i -E "$pattern" --include="*.ts" --include="*.js" --include="*.tsx" --include="*.jsx" --exclude-dir=node_modules --exclude-dir=dist . ; then
              echo "âŒ å‘ç°å¯èƒ½çš„ç¡¬ç¼–ç å¯†é’¥: $pattern"
              found_issues=true
            fi
          done
          
          if [ "$found_issues" = true ]; then
            echo "âŒ å®‰å…¨æ‰«æå¤±è´¥: å‘ç°ç¡¬ç¼–ç å¯†é’¥"
            echo "ğŸ’¡ æç¤º: è¯·ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶æ¥å­˜å‚¨æ•æ„Ÿä¿¡æ¯"
            exit 1
          else
            echo "âœ… å®‰å…¨æ‰«æé€šè¿‡: æœªå‘ç°ç¡¬ç¼–ç å¯†é’¥"
          fi

      - name: æ£€æŸ¥é…ç½®æ¨¡æ¿å®Œæ•´æ€§
        run: |
          echo "ğŸ” æ£€æŸ¥é…ç½®æ¨¡æ¿å®Œæ•´æ€§..."
          
          # ç¡®ä¿ .env.example åŒ…å«æ‰€æœ‰å¿…è¦çš„é…ç½®é¡¹
          required_keys=(
            "APP_NAME"
            "APP_VERSION"
            "NODE_ENV"
            "POSTHOG_KEY"
            "MODEL_CATALOG_URL"
            "AUTO_UPDATER_DISABLED"
          )
          
          missing_keys=()
          
          for key in "${required_keys[@]}"; do
            if ! grep -q "^$key=" .env.example 2>/dev/null; then
              missing_keys+=("$key")
            fi
          done
          
          if [ ${#missing_keys[@]} -gt 0 ]; then
            echo "âŒ .env.example ç¼ºå°‘å¿…è¦çš„é…ç½®é¡¹:"
            printf '%s\n' "${missing_keys[@]}"
            exit 1
          else
            echo "âœ… .env.example é…ç½®æ¨¡æ¿å®Œæ•´"
          fi