# Miaoda Windows构建全面修复规划

## 项目背景

Miaoda是基于Jan AI框架二次开发的智能对话桌面应用，采用Tauri + React + TypeScript技术栈。在从Jan框架迁移到Miaoda品牌的过程中，Windows构建系统出现了多重问题，导致无法正常生成Windows安装包。

### 核心问题总结

1. **硬编码路径问题**：NSIS模板中存在硬编码路径 `D:\a\jan\jan\`，导致在不同构建环境中找不到文件
2. **构建流程不匹配**：build-windows.yml与template-tauri-build-windows-x64.yml存在配置冲突，Makefile与package.json脚本系统不一致
3. **品牌迁移不完整**：大量Jan品牌残留的配置、路径和标识未完全替换为Miaoda
4. **依赖工具链混乱**：工具版本不一致，缺失关键构建工具（ctoml、AzureSignTool等）
5. **签名配置缺失**：Windows代码签名流程不完整，影响发布质量

## 修复目标

### 主要目标
- ✅ 修复Windows平台构建失败问题，生成可用的安装包
- ✅ 完成Jan到Miaoda的品牌迁移，清理所有残留配置
- ✅ 建立稳定可靠的CI/CD构建流程
- ✅ 实现Windows应用的代码签名和自动发布

### 成功标准
- [ ] GitHub Actions构建成功率达到90%以上
- [ ] 生成正确命名的Miaoda Windows安装包（.exe和.msi格式）
- [ ] 安装包可正常安装、运行和卸载
- [ ] 应用启动时显示正确的Miaoda品牌信息
- [ ] 构建时间控制在30分钟以内

## 三层优先级修复策略

### 第1层：紧急修复（必须立即解决）

#### 任务1.1：修复NSIS模板硬编码路径
**负责团队**：backend-developer
**预估时间**：1-2天
**优先级**：🔥 紧急

**具体步骤**：
1. 分析src-tauri/tauri.conf.json中的NSIS配置
2. 识别所有硬编码路径 `D:\a\jan\jan\`
3. 替换为环境变量或相对路径
4. 更新GitHub Actions工作流中的路径变量
5. 测试路径解析的正确性

**交付物**：
- 修复的tauri.conf.json配置文件
- 更新的GitHub Actions环境变量配置
- 路径修复验证报告

#### 任务1.2：统一构建脚本系统  
**负责团队**：backend-developer
**预估时间**：2-3天
**优先级**：🔥 紧急

**具体步骤**：
1. 对比build-windows.yml和template-tauri-build-windows-x64.yml的差异
2. 选择更完善的构建流程作为标准
3. 废弃冲突的Makefile，统一使用package.json脚本
4. 更新构建命令为build:tauri:win32
5. 验证构建步骤的完整性

**交付物**：
- 统一的.github/workflows/build-windows.yml文件
- 更新的package.json构建脚本
- 构建流程文档

#### 任务1.3：清理Jan品牌残留
**负责团队**：backend-developer  
**预估时间**：2-3天
**优先级**：🔥 紧急

**具体步骤**：
1. 全项目搜索"jan"、"Jan"、"JAN"字符串
2. 系统性替换为对应的Miaoda标识
3. 更新应用图标、名称和描述信息
4. 验证UI界面的品牌一致性
5. 更新文档和README文件

**交付物**：
- 品牌清理报告和清单
- 更新的配置文件
- UI品牌一致性验证报告

### 第2层：构建系统重构（核心问题）

#### 任务2.1：修复工具链和依赖版本
**负责团队**：backend-developer
**预估时间**：2-3天  
**优先级**：⚠️ 重要

**具体步骤**：
1. 统一Node.js、Yarn、Rust工具链版本
2. 添加缺失的构建工具（ctoml、AzureSignTool）
3. 锁定关键依赖版本，防止版本冲突
4. 优化依赖安装和缓存策略
5. 测试工具链的稳定性

**交付物**：
- 版本锁定的package.json和Cargo.toml
- 工具安装脚本
- 依赖管理文档

#### 任务2.2：优化构建性能
**负责团队**：performance-optimizer
**预估时间**：2天
**优先级**：📈 优化

**具体步骤**：
1. 分析当前构建时间瓶颈
2. 优化Rust编译缓存策略  
3. 并行化构建步骤
4. 优化资源文件处理
5. 建立构建性能监控

**交付物**：
- 性能优化报告
- 优化的构建配置
- 性能监控仪表板

#### 任务2.3：建立动态配置管理
**负责团队**：backend-developer
**预估时间**：2-3天
**优先级**：⚠️ 重要

**具体步骤**：
1. 创建环境变量配置文件
2. 实现配置模板替换系统
3. 建立配置验证机制
4. 支持开发/测试/生产环境切换
5. 文档化配置管理流程

**交付物**：
- 配置管理系统代码
- 环境配置模板文件
- 配置管理使用文档

### 第3层：质量保证（确保稳定性）

#### 任务3.1：完善代码签名流程
**负责团队**：backend-developer
**预估时间**：2-3天
**优先级**：🔐 安全

**具体步骤**：
1. 配置Azure Key Vault证书管理
2. 集成AzureSignTool到构建流程
3. 实现自动化签名验证
4. 建立证书过期监控
5. 测试签名的有效性

**交付物**：
- 代码签名配置和脚本
- 证书管理文档
- 签名验证报告

#### 任务3.2：建立自动化测试
**负责团队**：backend-developer + code-reviewer
**预估时间**：3-4天
**优先级**：🧪 测试

**具体步骤**：
1. 创建Windows构建测试套件
2. 实现安装包完整性验证
3. 添加应用启动和功能测试
4. 集成到CI/CD流程
5. 建立测试报告机制

**交付物**：
- 自动化测试脚本
- 测试用例文档
- 测试报告模板

#### 任务3.3：完善监控和错误处理
**负责团队**：backend-developer
**预估时间**：2天
**优先级**：📊 监控

**具体步骤**：
1. 建立构建状态监控
2. 实现自动化错误通知
3. 创建构建日志分析工具
4. 建立故障恢复机制
5. 完善文档和运维指南

**交付物**：
- 监控和告警系统
- 错误处理脚本
- 运维操作手册

## 风险评估与应对策略

### 高风险项目
1. **签名证书获取延迟**
   - 风险：无法及时获取有效的代码签名证书
   - 应对：准备无签名版本作为备用方案
   
2. **依赖版本冲突**  
   - 风险：新的依赖更新可能引起其他模块故障
   - 应对：锁定关键依赖版本，建立回滚机制

3. **品牌迁移遗漏**
   - 风险：部分Jan标识未完全清理，影响品牌一致性
   - 应对：建立品牌检查清单，多轮验证

### 中等风险项目
1. **构建环境差异**
   - 风险：本地构建成功但CI环境失败
   - 应对：标准化构建环境，添加环境检查步骤

2. **性能优化过度**
   - 风险：性能优化可能影响构建稳定性
   - 应对：渐进式优化，保留回滚选项

## 验收标准和测试计划

### 功能性验收标准
- [ ] GitHub Actions构建流程完整运行无错误
- [ ] 生成Miaoda_x.x.x_x64-setup.exe安装包
- [ ] 安装包大小合理（50-200MB）
- [ ] 安装程序可正常安装到Windows 10/11
- [ ] 应用启动时间≤10秒
- [ ] 应用界面完全显示Miaoda品牌

### 技术性验收标准  
- [ ] 所有硬编码路径已替换为动态配置
- [ ] 构建时间≤30分钟
- [ ] 依赖安装成功率≥95%
- [ ] 代码签名验证通过
- [ ] 内存占用≤500MB

### 用户体验验收标准
- [ ] 安装过程用户友好，无技术错误提示
- [ ] 应用卸载干净，无残留文件
- [ ] 应用图标和界面美观一致
- [ ] 功能完整，无关键功能缺失

## 时间估算和里程碑

### 总体时间规划：14-18个工作日

**第1周（第1-5天）**：紧急修复阶段
- 天1-2：修复硬编码路径问题
- 天3-5：统一构建脚本和清理品牌残留

**第2周（第6-10天）**：系统重构阶段  
- 天6-8：修复工具链和建立配置管理
- 天9-10：性能优化和测试

**第3周（第11-15天）**：质量保证阶段
- 天11-13：完善签名和自动化测试
- 天14-15：监控系统和最终验证

**第4周（第16-18天）**：缓冲和优化
- 天16-17：问题修复和优化调整
- 天18：最终验收和文档整理

### 关键里程碑
1. **里程碑1**（第5天）：基础构建流程恢复正常
2. **里程碑2**（第10天）：完整功能的安装包生成成功
3. **里程碑3**（第15天）：签名和测试流程完善
4. **里程碑4**（第18天）：项目完全达到发布标准

## 后续维护计划

### 短期维护（1个月内）
- 监控构建成功率，及时修复新出现的问题
- 收集用户反馈，修复安装和使用问题
- 完善文档和操作指南

### 长期维护（3个月内）
- 建立定期更新机制
- 扩展到macOS和Linux平台
- 优化构建性能和用户体验
- 建立社区反馈机制

---

**文档版本**：v1.0
**创建时间**：2025-09-11
**负责团队**：Miaoda开发团队
**预计完成时间**：2025-09-29