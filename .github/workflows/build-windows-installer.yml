name: Build Windows Installer Packages

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 0.6.599)'
        required: true
        default: '0.6.599'
      build_x86:
        description: 'Build 32-bit version'
        required: false
        default: 'true'
        type: boolean
      build_x64:
        description: 'Build 64-bit version'
        required: false
        default: 'true'
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-windows-packages:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            arch: x64
            enabled: ${{ github.event.inputs.build_x64 == 'true' }}
          - target: i686-pc-windows-msvc  
            arch: x86
            enabled: ${{ github.event.inputs.build_x86 == 'true' }}
    
    if: matrix.enabled
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
      
      - name: Enable Corepack and Yarn
        run: |
          corepack enable
          corepack prepare yarn@4.5.3 --activate
          yarn --version
      
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.77.2
          targets: ${{ matrix.target }}
          components: rustfmt, clippy
      
      - name: Install Windows build dependencies
        run: |
          # å®‰è£…å¿…è¦çš„æž„å»ºå·¥å…·
          choco install jq -y
          
          # å®‰è£… NSIS (Nullsoft Scriptable Install System)
          choco install nsis -y
          
          # éªŒè¯å®‰è£…
          makensis /VERSION
          jq --version
      
      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            .yarn/cache
            node_modules
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
          key: ${{ runner.os }}-${{ matrix.arch }}-${{ hashFiles('**/yarn.lock', '**/Cargo.lock') }}
      
      - name: Install dependencies
        run: yarn install --immutable
      
      - name: Update version and configure
        shell: bash
        run: |
          VERSION=${{ github.event.inputs.version }}
          
          # æ›´æ–°ç‰ˆæœ¬å·
          jq --arg version "$VERSION" '.version = $version' web-app/package.json > web-app/package.json.tmp && mv web-app/package.json.tmp web-app/package.json
          jq --arg version "$VERSION" '.version = $version' src-tauri/tauri.conf.json > src-tauri/tauri.conf.json.tmp && mv src-tauri/tauri.conf.json.tmp src-tauri/tauri.conf.json
          sed -i "0,/^version = \".*\"/s/^version = \".*\"/version = \"$VERSION\"/" src-tauri/Cargo.toml
          
          echo "Updated version to $VERSION"
      
      - name: Build application
        run: |
          # æž„å»ºå‰ç«¯
          yarn build:core
          yarn build:extensions-web
          yarn build:web
          
          # æž„å»º Tauri åº”ç”¨
          yarn tauri build --target ${{ matrix.target }}
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
      
      - name: Create standard Windows packages
        shell: pwsh
        run: |
          $distDir = "dist/windows-packages"
          $arch = "${{ matrix.arch }}"
          $version = "${{ github.event.inputs.version }}"
          $target = "${{ matrix.target }}"
          
          New-Item -ItemType Directory -Force -Path "$distDir/$arch"
          New-Item -ItemType Directory -Force -Path "$distDir/portable"
          
          Write-Host "Creating packages for $arch architecture"
          
          # å¤åˆ¶ MSI å®‰è£…åŒ…ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          $msiFiles = Get-ChildItem -Path "src-tauri/target/$target/release/bundle" -Filter "*.msi" -Recurse -ErrorAction SilentlyContinue
          foreach ($msi in $msiFiles) {
              $newName = "Miaoda-v$version-$arch.msi"
              Copy-Item $msi.FullName -Destination "$distDir/$arch/$newName"
              Write-Host "Created MSI: $newName"
          }
          
          # å¤åˆ¶ NSIS å®‰è£…åŒ…ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          $exeFiles = Get-ChildItem -Path "src-tauri/target/$target/release/bundle" -Filter "*.exe" -Recurse -ErrorAction SilentlyContinue
          foreach ($exe in $exeFiles) {
              $newName = "Miaoda-v$version-$arch-setup.exe"
              Copy-Item $exe.FullName -Destination "$distDir/$arch/$newName"
              Write-Host "Created Setup: $newName"
          }
          
          # åˆ›å»ºä¾¿æºç‰ˆ
          $portableDir = "$distDir/portable/Miaoda-$arch"
          New-Item -ItemType Directory -Force -Path $portableDir
          
          # å¤åˆ¶ä¸»ç¨‹åº
          $exePath = "src-tauri/target/$target/release/miaoda.exe"
          if (Test-Path $exePath) {
              Copy-Item $exePath -Destination "$portableDir/Miaoda.exe"
              Write-Host "Copied main executable for portable version"
          }
          
          # åˆ›å»ºå¯åŠ¨è„šæœ¬
          @"
          @echo off
          chcp 65001 > nul
          cd /d "%~dp0"
          echo Starting Miaoda...
          start "" Miaoda.exe
          "@ | Out-File -FilePath "$portableDir/å¯åŠ¨.bat" -Encoding ASCII
          
          @"
          @echo off
          chcp 65001 > nul
          cd /d "%~dp0"
          echo Starting Miaoda...
          start "" Miaoda.exe
          "@ | Out-File -FilePath "$portableDir/Start.bat" -Encoding ASCII
          
          # åˆ›å»ºè¯´æ˜Žæ–‡ä»¶
          @"
          Miaoda Windows Portable v$version
          ===================================
          
          ç³»ç»Ÿè¦æ±‚ / System Requirements:
          - Windows 7 SP1 / 8 / 10 / 11
          - æž¶æž„ / Architecture: $arch
          - WebView2 Runtime (è‡ªåŠ¨å®‰è£… / Auto-installed)
          
          ä½¿ç”¨è¯´æ˜Ž / Usage:
          1. åŒå‡» Miaoda.exe æˆ– å¯åŠ¨.bat å¯åŠ¨åº”ç”¨
             Double-click Miaoda.exe or Start.bat to launch
          2. æœ¬ç‰ˆæœ¬ä¸ºä¾¿æºç‰ˆï¼Œæ— éœ€å®‰è£…
             This is a portable version, no installation required
          3. æ‰€æœ‰æ–‡ä»¶è¯·ä¿æŒåœ¨åŒä¸€ç›®å½•ä¸‹
             Keep all files in the same directory
          
          æž„å»ºä¿¡æ¯ / Build Info:
          - ç‰ˆæœ¬ / Version: $version
          - æž¶æž„ / Architecture: $arch ($target)
          - æž„å»ºæ—¶é—´ / Build Time: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss')
          - å…¼å®¹æ€§ / Compatibility: Windows 7+
          
          æ›´å¤šä¿¡æ¯ / More Info: https://github.com/miounet11/miaodanew
          "@ | Out-File -FilePath "$portableDir/README.txt" -Encoding UTF8
          
          # åˆ›å»º ZIP åŽ‹ç¼©åŒ…
          Compress-Archive -Path $portableDir -DestinationPath "$distDir/portable/Miaoda-v$version-Windows-$arch-Portable.zip"
          Remove-Item -Recurse -Force $portableDir
          Write-Host "Created portable ZIP package"
          
          # æ˜¾ç¤ºæž„å»ºç»“æžœ
          Write-Host "`nBuild results for $arch architecture:"
          Get-ChildItem -Path $distDir -Recurse -File | ForEach-Object {
              $size = [math]::Round($_.Length / 1MB, 2)
              Write-Host "  $($_.Name): $size MB"
          }
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: miaoda-windows-${{ matrix.arch }}-${{ github.event.inputs.version }}
          path: dist/windows-packages/**/*
          retention-days: 30

  create-release-summary:
    needs: build-windows-packages
    if: always() && needs.build-windows-packages.result == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Create release summary
        run: |
          VERSION="${{ github.event.inputs.version }}"
          
          cat > RELEASE_NOTES.md << EOF
          # Miaoda Windows å‘è¡Œç‰ˆ v$VERSION
          
          ## ðŸ“¦ å®‰è£…åŒ…è¯´æ˜Ž
          
          ### ðŸ–¥ï¸ æ ‡å‡†å®‰è£…åŒ… (æŽ¨è)
          - **Miaoda-v$VERSION-x64-setup.exe** - 64ä½å®‰è£…ç¨‹åº
          - **Miaoda-v$VERSION-x86-setup.exe** - 32ä½å®‰è£…ç¨‹åº  
          
          ### ðŸ“¦ MSI å®‰è£…åŒ… (ä¼ä¸šéƒ¨ç½²)
          - **Miaoda-v$VERSION-x64.msi** - 64ä½ MSI åŒ…
          - **Miaoda-v$VERSION-x86.msi** - 32ä½ MSI åŒ…
          
          ### ðŸ“ ä¾¿æºç‰ˆ (ç»¿è‰²ç‰ˆ)
          - **Miaoda-v$VERSION-Windows-x64-Portable.zip** - 64ä½ä¾¿æºç‰ˆ
          - **Miaoda-v$VERSION-Windows-x86-Portable.zip** - 32ä½ä¾¿æºç‰ˆ
          
          ## ðŸŽ¯ ç³»ç»Ÿå…¼å®¹æ€§
          
          âœ… **Windows 7 SP1** åŠä»¥ä¸Šç‰ˆæœ¬  
          âœ… **32ä½å’Œ64ä½** ç³»ç»Ÿå®Œå…¨æ”¯æŒ  
          âœ… **WebView2** è¿è¡Œæ—¶è‡ªåŠ¨å®‰è£…  
          âœ… **ä¸­è‹±æ–‡ç•Œé¢** æ”¯æŒ  
          
          ## ðŸš€ å®‰è£…æ–¹å¼é€‰æ‹©
          
          | ç”¨æˆ·ç±»åž‹ | æŽ¨èå®‰è£…åŒ… | è¯´æ˜Ž |
          |---------|-----------|------|
          | **æ™®é€šç”¨æˆ·** | setup.exe | è‡ªåŠ¨å®‰è£…ï¼Œé›†æˆç³»ç»Ÿ |
          | **ä¼ä¸šç”¨æˆ·** | .msi æ–‡ä»¶ | æ”¯æŒé™é»˜å®‰è£…å’Œç»„ç­–ç•¥ |  
          | **ä¾¿æºä½¿ç”¨** | Portable.zip | ç»¿è‰²ç‰ˆï¼Œæ— éœ€å®‰è£… |
          | **å¼€å‘æµ‹è¯•** | Portable.zip | å¿«é€Ÿæµ‹è¯•ï¼Œä¸å½±å“ç³»ç»Ÿ |
          
          ## ðŸ“‹ ç‰ˆæœ¬ç‰¹æ€§
          
          - **ç‰ˆæœ¬å·**: $VERSION
          - **æž„å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S')
          - **æ”¯æŒæž¶æž„**: x64, x86
          - **æœ€ä½Žè¦æ±‚**: Windows 7 SP1
          - **å®‰è£…æ–¹å¼**: æ ‡å‡†å®‰è£…ã€MSIã€ä¾¿æºç‰ˆ
          
          ## ðŸ”— ä¸‹è½½å’Œæ”¯æŒ
          
          - **ä¸‹è½½åœ°å€**: [GitHub Actions Artifacts](https://github.com/miounet11/miaodanew/actions)
          - **é—®é¢˜åé¦ˆ**: https://github.com/miounet11/miaodanew/issues
          - **ä½¿ç”¨æ–‡æ¡£**: https://github.com/miounet11/miaodanew
          EOF
          
          echo "Release notes created successfully!"
          cat RELEASE_NOTES.md
      
      - name: Upload release notes
        uses: actions/upload-artifact@v4
        with:
          name: release-notes-${{ github.event.inputs.version }}
          path: RELEASE_NOTES.md
          retention-days: 90